
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog Bom!!BO!">
    <title>Redis - Blog Bom!!BO!</title>
    <meta name="author" content="Eddie Lee">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eddie Lee","sameAs":["https://github.com/RadianceL"],"image":"eddie-personal.jpg"},"articleBody":"Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as strings, lists, maps, sets, sorted sets, hyperloglogs, bitmaps and spatial indexes. The project is mainly developed by Salvatore Sanfilippo and is currently sponsored by Redis Labs.[4]\n—Wikipedia\nRedis 简介高并发系统瓶颈点一部分在于数据库访问，网络延迟。Redis的作用是缓存数据库内容，使其不必每次都访问数据库。\nRedis主要数据结构String、List、Hash、Set、ZSet\nJava使用Redis首先Maven添加项目依赖：12345&lt;dependency&gt;    &lt;groupId&gt;redis.clients&lt;/groupId&gt;    &lt;artifactId&gt;jedis&lt;/artifactId&gt;    &lt;version&gt;&#123;jedis.version&#125;&lt;/version&gt;&lt;/dependency&gt;\n其次，Redis接收的是序列化后的二进制数据，如果使用java自带的序列化工具效率是不够好的，这里我选择使用protostuff,说白了就是第三方序列化工具12345678910&lt;dependency&gt;  &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt;  &lt;artifactId&gt;protostuff-core&lt;/artifactId&gt;  &lt;version&gt;&#123;protostuff.version&#125;&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt;  &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt;  &lt;artifactId&gt;protostuff-runtime&lt;/artifactId&gt;  &lt;version&gt;&#123;protostuff.version&#125;&lt;/version&gt;&lt;/dependency&gt;\n这就是Redis需要添加的所有依赖了.\n接下来就是Java代码的部分，通常都会放在dao层下，新建一个cache包，用来存放所有reids的代码。\n12345678910public class RedisCache &#123;    //所需的全局变量    private final JedisPool jedisPool;//连接池    private final Logger logger = LoggerFactory.getLogger(this.getClass());//日志我这里使用的是slf4j配合logback    //这个变量用于protostuff解析你的entity    private RuntimeSchema&lt;User&gt; schema = RuntimeSchema.createFrom(User.class);  &#125;\n连接池是用来通过ip,port实例化的，这个东西就相当于数据库的dataSource。RuntimeSchema用来解析entity，通过反射机制，获取对象的属性和方法名称。\n需要的方法大概有两种，一种put一种get，存到reids和取出。12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public String putUser(User user)&#123;    try&#123;        //获取连接        Jedis jedis = jedisPool.getResource();        try &#123;            //设置一个id，相当于map的&lt;key,value&gt;            String key = \"seckill:\"+user.getId();            //通过ProtobufIOUtil序列化user对象，需要传入一个对象，对象对应的schema（解析）,最后是一个默认大小的缓存            byte[] bytes = ProtobufIOUtil.toByteArray(user,schema,                    LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));            //这一步将序列化的数据set到redis，中间的参数是有效时间，单位应该是分钟            String result = jedis.setex(key.getBytes(), 60 * 60, bytes);            return result;        &#125;finally &#123;            jedis.close();        &#125;    &#125;catch (Exception e)&#123;        logger.error(e.getMessage(),e);    &#125;    return null;&#125;public User getUser(long id)&#123;    try&#123;        //同样需要获取连接资源        Jedis jedis = jedisPool.getResource();        try &#123;            //根据存数据key的规则获取一个key            String key = \"produce:\"+id;            //通过key获取二进制数据            byte[] bytes = jedis.get(key.getBytes());            //如果返回值不为null，说明成功拿到数据，如果没有，返回null            if (bytes!=null)&#123;                //如果拿到了就需要反序列化，变成一个user对象，通过schema生成一个空对象                User user = schema.newMessage();                //通过ProtobufIOUtil将之前的空对象填充                ProtobufIOUtil.mergeFrom(bytes,user,schema);                return user;            &#125;        &#125;finally &#123;            jedis.close();        &#125;    &#125;catch (Exception e)&#123;        logger.error(e.getMessage(),e);    &#125;    return null;&#125;\n以上就是java使用redis的基础用法，我不是运维，具体redis配置，集群暂不考虑。\n更新 - 2018-07-30\n很久之前就借鉴了网上的代码做了一个Redis库，但后期没时间完成更复杂的部分，在这边分享一下。\n首先入口是这个类，很简单的构建了一个工厂，生成RedisClient对象。1234567891011121314151617181920212223public class RedisFactory &#123;    private static RedisClient redisClient;    public static final synchronized RedisClient singletonBuild(String ip,int port)&#123;        if (redisClient == null) &#123;            redisClient = new RedisClient(ip, port);        &#125;        return redisClient;    &#125;\tpublic static final RedisClient build(String ip,int port)&#123;    \treturn new RedisClient(ip, port);\t&#125;    public static final RedisSentinelClient build(String masterName,Set&lt;String&gt; sentinels)&#123;        return new RedisSentinelClient(masterName,sentinels,new JedisPoolConfig());    &#125;    public static final void setSerializeClass(Class cls)&#123;        ProtostuffUtils.registerWrapperClass(cls);    &#125;&#125;\n其实RedisClient就是封装了一些Jedis的方法，但在这里，做了一个优化，原Jedis的方法需要自己实现序列化，RedisClient这个类包装的方法会有个万能Reids序列化的工具。\n这个类大概是这个样子的。1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495public class RedisClient &#123;    private final JedisPool jedisPool;    private static int maxTotal;    private static int maxIdle;    private static int maxWaitMillis;    private static boolean testOnBorrow;    static&#123;        final Properties properties = new Properties();        try (final InputStream stream = RedisClient.class.getClassLoader().getResourceAsStream(\"cache.properties\")) &#123;            properties.load(stream);            maxTotal = Integer.parseInt(properties.getProperty(\"common.redis.maxTotal\",\"1000\"));            maxIdle = Integer.parseInt(properties.getProperty(\"common.redis.maxIdle\",\"100\"));            maxWaitMillis = Integer.parseInt(properties.getProperty(\"common.redis.maxWaitMillis\",\"10000\"));            testOnBorrow = Boolean.parseBoolean(properties.getProperty(\"common.redis.testOnBorrow\",\"true\"));        &#125; catch (IOException e) &#123;            e.printStackTrace();        &#125;        JedisPoolConfig config = new JedisPoolConfig();        //配置最大jedis实例数        config.setMaxTotal(maxTotal);        //配置资源池最大闲置数        config.setMaxIdle(maxIdle);        //等待可用连接的最大时间        config.setMaxWaitMillis(maxWaitMillis);        //在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的        config.setTestOnBorrow(testOnBorrow);    &#125;    public RedisClient(String ip,int port)&#123;        jedisPool = new JedisPool(ip,port);    &#125;    public String putData(String redisKey,Object param)&#123;        Jedis jedis = jedisPool.getResource();        try &#123;            byte[] serialize = ProtostuffUtils.serialize(param);            String result = jedis.setex(redisKey.getBytes(), 60 * 60 * 60, serialize);            if (result!= null)                return result;            throw new CacheException(\"Put object exception\");        &#125;finally &#123;            if (jedis != null) &#123;                jedisPool.returnResource(jedis);            &#125;        &#125;    &#125;    public &lt;T&gt; T getData(String redisKey,Class cla)&#123;        Jedis jedis = jedisPool.getResource();        try &#123;            byte[] bytes = jedis.get(redisKey.getBytes());            Object deserialize = ProtostuffUtils.deserialize(bytes, cla);            if (deserialize!= null)                return (T) deserialize;            throw new CacheException(\"Get object exception\");        &#125;finally &#123;            if (jedis != null) &#123;                jedisPool.returnResource(jedis);            &#125;        &#125;    &#125;    public boolean publishMessage(String channel,String msg)&#123;       Jedis jedis = jedisPool.getResource();       try&#123;           Long publishCount = jedis.publish(channel, msg);           System.out.println(\"发送成功，该频道有\" +publishCount + \"个订阅者\");       &#125;finally &#123;           if (jedis != null) &#123;               jedisPool.returnResource(jedis);           &#125;       &#125;       return true;   &#125;   public void subscribeMessage(JedisPubSub pubSub, String channel)&#123;       Jedis jedis = jedisPool.getResource();       try &#123;           jedis.subscribe(pubSub, channel);       &#125;finally &#123;           if (jedis != null) &#123;               jedisPool.returnResource(jedis);           &#125;       &#125;   &#125;    //省略更多方法&#125;\n这里面有两个方法要说明一下，[publishMessage]、[subscribeMessage]。Redis可以作为Mq做广播和接收，但这种方法并非安全分布式队列的应用场景和缓存的应用场景是不一样的。如果有没来得及持久化的数据怎么办？从业务系统的角度，已经成功发送给消息队列了。消息队列也以为Redis妥妥地收好了。可Redis还没写到日记里，更没有及时通知小伙伴，挂了。可能是断电了，可能是进程被kill了。后果会怎样？已经执行过的任务会再次执行一遍。已经放到队列中的任务，消失了。标记为已经完成的任务，状态变为“进行中”了，然后又被执行了一遍。后果不可接受。\n所以如果使用这两个方法，一定要做好相应的措施，例如：采用 Master－Slave 数据复制模式，配置bgsave，追加存储到aof。在从服务器上配置bgsave，不影响master性能。\n之后一个很重要的类就是序列化工具类，使用Protostuff众所周知吧，Protostuff是一个很厉害的序列化工具，这里对Protostuff做一个包装。123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109public class ProtostuffUtils &#123;    /**     * 需要使用包装类进行序列化/反序列化的class集合     */    private static final Set&lt;Class&lt;?&gt;&gt; WRAPPER_SET = new HashSet&lt;&gt;();    /**     * 序列化/反序列化包装类 Class 对象     */    private static final Class&lt;SerializeDeserializeWrapper&gt; WRAPPER_CLASS = SerializeDeserializeWrapper.class;    /**     * 序列化/反序列化包装类 Schema 对象     */    private static final Schema&lt;SerializeDeserializeWrapper&gt; WRAPPER_SCHEMA = RuntimeSchema.createFrom(WRAPPER_CLASS);    /**     * 缓存对象及对象schema信息集合     */    private static final Map&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt; CACHE_SCHEMA = new HashMap&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt;();    /**     * 预定义一些Protostuff无法直接序列化/反序列化的对象     */    static &#123;        WRAPPER_SET.add(List.class);        WRAPPER_SET.add(ArrayList.class);        WRAPPER_SET.add(Map.class);\t    WRAPPER_SET.add(HashMap.class);        WRAPPER_SET.add(Object.class);    &#125;    /**     * 注册需要使用包装类进行序列化/反序列化的 Class 对象     *     * @param cls 需要包装的类型 Class 对象     */    public static void registerWrapperClass(Class cls) &#123;        WRAPPER_SET.add(cls);    &#125;    /**     * 获取序列化对象类型的schema     *     * @param cls 序列化对象的class     * @param &lt;T&gt; 序列化对象的类型     * @return 序列化对象类型的schema     */    private static &lt;T&gt; Schema&lt;T&gt; getSchema(Class&lt;T&gt; cls) &#123;        Schema&lt;T&gt; schema = (Schema&lt;T&gt;) CACHE_SCHEMA.get(cls);        if (schema == null) &#123;            schema = RuntimeSchema.createFrom(cls);            CACHE_SCHEMA.put(cls, schema);        &#125;        return schema;    &#125;    /**     * 序列化对象     *     * @param obj 需要序列化的对象     * @param &lt;T&gt; 序列化对象的类型     * @return 序列化后的二进制数组     */    public static &lt;T&gt; byte[] serialize(T obj) &#123;        Class&lt;T&gt; clazz = (Class&lt;T&gt;) obj.getClass();        LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);        try &#123;            Object serializeObject = obj;            Schema schema = WRAPPER_SCHEMA;            if (!WRAPPER_SET.contains(clazz)) &#123;                schema = getSchema(clazz);            &#125; else &#123;                serializeObject = SerializeDeserializeWrapper.builder(obj);            &#125;            return ProtostuffIOUtil.toByteArray(serializeObject, schema, buffer);        &#125; catch (Exception e) &#123;            throw new IllegalStateException(e.getMessage(), e);        &#125; finally &#123;            buffer.clear();        &#125;    &#125;    /**     * 反序列化对象     *     * @param data  需要反序列化的二进制数组     * @param clazz 反序列化后的对象class     * @param &lt;T&gt;   反序列化后的对象类型     * @return 反序列化后的对象集合     */    public static &lt;T&gt; T deserialize(byte[] data, Class&lt;T&gt; clazz) &#123;        try &#123;            if (!WRAPPER_SET.contains(clazz)) &#123;                T message = clazz.newInstance();                Schema&lt;T&gt; schema = getSchema(clazz);                ProtostuffIOUtil.mergeFrom(data, message, schema);                return message;            &#125; else &#123;                SerializeDeserializeWrapper&lt;T&gt; wrapper = new SerializeDeserializeWrapper&lt;&gt;();                ProtostuffIOUtil.mergeFrom(data, wrapper, WRAPPER_SCHEMA);                return wrapper.getData();            &#125;        &#125; catch (Exception e) &#123;            throw new IllegalStateException(e.getMessage(), e);        &#125;    &#125;&#125;\n这个项目我已经放到GitHUb上了 地址\n","dateCreated":"2018-03-20T12:55:33+08:00","dateModified":"2019-05-06T16:16:17+08:00","datePublished":"2018-03-20T12:55:33+08:00","description":"Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as strings, lists, maps, sets, sorted sets, hyperloglogs, bitmaps and spatial indexes. The project is mainly developed by Salvatore Sanfilippo and is currently sponsored by Redis Labs.[4]\n—Wikipedia","headline":"Redis","image":["https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&fm=27&gp=0.jpg","http://old.bz55.com/uploads/allimg/150719/139-150GZZ039.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://radiancel.github.io/2018/03/20/Redis/"},"publisher":{"@type":"Organization","name":"Eddie Lee","sameAs":["https://github.com/RadianceL"],"image":"eddie-personal.jpg","logo":{"@type":"ImageObject","url":"eddie-personal.jpg"}},"url":"https://radiancel.github.io/2018/03/20/Redis/","keywords":"Redis","thumbnailUrl":"https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&fm=27&gp=0.jpg"}</script>
    <meta name="description" content="Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as s">
<meta name="keywords" content="Redis">
<meta property="og:type" content="blog">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://radiancel.github.io/2018/03/20/Redis/index.html">
<meta property="og:site_name" content="Blog Bom!!BO!">
<meta property="og:description" content="Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as s">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-05-06T08:16:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis">
<meta name="twitter:description" content="Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as s">
    
    
        
    
    
        <meta property="og:image" content="https://radiancel.github.io/assets/images/eddie-personal.jpg"/>
    
    
        <meta property="og:image" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&amp;fm=27&amp;gp=0.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&amp;fm=27&amp;gp=0.jpg" />
    
    
        <meta property="og:image" content="http://old.bz55.com/uploads/allimg/150719/139-150GZZ039.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://old.bz55.com/uploads/allimg/150719/139-150GZZ039.jpg" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Blog Bom!!BO!</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/eddie-personal.jpg" alt="Author&#39;s picture">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/eddie-personal.jpg" alt="Author&#39;s picture">
                </a>
                <h4 class="sidebar-profile-name">Eddie Lee</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="Home">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="Categories">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="Tags">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="Archives">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="About">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/RadianceL" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    " style="background-image:url('http://old.bz55.com/uploads/allimg/150719/139-150GZZ039.jpg');" data-behavior="4">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Redis
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-03-20T12:55:33+08:00">
	
		    Mar 20, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java/">Java</a>


    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Redis is an open-source in-memory database project implementing a distributed, in-memory key-value store with optional durability. Redis supports different kinds of abstract data structures, such as strings, lists, maps, sets, sorted sets, hyperloglogs, bitmaps and spatial indexes. The project is mainly developed by Salvatore Sanfilippo and is currently sponsored by Redis Labs.[4]</p>
<p><div align="right">—Wikipedia</div><br><a id="more"></a></p>
<h2 id="Redis-简介"><a href="#Redis-简介" class="headerlink" title="Redis 简介"></a>Redis 简介</h2><p>高并发系统瓶颈点一部分在于数据库访问，网络延迟。Redis的作用是缓存数据库内容，使其不必每次都访问数据库。</p>
<h2 id="Redis主要数据结构"><a href="#Redis主要数据结构" class="headerlink" title="Redis主要数据结构"></a>Redis主要数据结构</h2><p>String、List、Hash、Set、ZSet</p>
<h2 id="Java使用Redis"><a href="#Java使用Redis" class="headerlink" title="Java使用Redis"></a>Java使用Redis</h2><p>首先Maven添加项目依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>&#123;jedis.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其次，Redis接收的是序列化后的二进制数据，如果使用java自带的序列化工具效率是不够好的，这里我选择使用<code>protostuff</code>,说白了就是第三方序列化工具<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>&#123;protostuff.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>&#123;protostuff.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这就是Redis需要添加的所有依赖了.</p>
<p>接下来就是Java代码的部分，通常都会放在dao层下，新建一个cache包，用来存放所有reids的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所需的全局变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;<span class="comment">//连接池</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());<span class="comment">//日志我这里使用的是slf4j配合logback</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个变量用于protostuff解析你的entity</span></span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;User&gt; schema = RuntimeSchema.createFrom(User.class);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>连接池是用来通过ip,port实例化的，这个东西就相当于数据库的dataSource。<br>RuntimeSchema用来解析entity，通过反射机制，获取对象的属性和方法名称。</p>
<p>需要的方法大概有两种，一种put一种get，存到reids和取出。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">putUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置一个id，相当于map的&lt;key,value&gt;</span></span><br><span class="line">            String key = <span class="string">"seckill:"</span>+user.getId();</span><br><span class="line">            <span class="comment">//通过ProtobufIOUtil序列化user对象，需要传入一个对象，对象对应的schema（解析）,最后是一个默认大小的缓存</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = ProtobufIOUtil.toByteArray(user,schema,</span><br><span class="line">                    LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">            <span class="comment">//这一步将序列化的数据set到redis，中间的参数是有效时间，单位应该是分钟</span></span><br><span class="line">            String result = jedis.setex(key.getBytes(), <span class="number">60</span> * <span class="number">60</span>, bytes);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        logger.error(e.getMessage(),e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//同样需要获取连接资源</span></span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据存数据key的规则获取一个key</span></span><br><span class="line">            String key = <span class="string">"produce:"</span>+id;</span><br><span class="line">            <span class="comment">//通过key获取二进制数据</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">            <span class="comment">//如果返回值不为null，说明成功拿到数据，如果没有，返回null</span></span><br><span class="line">            <span class="keyword">if</span> (bytes!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//如果拿到了就需要反序列化，变成一个user对象，通过schema生成一个空对象</span></span><br><span class="line">                User user = schema.newMessage();</span><br><span class="line">                <span class="comment">//通过ProtobufIOUtil将之前的空对象填充</span></span><br><span class="line">                ProtobufIOUtil.mergeFrom(bytes,user,schema);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        logger.error(e.getMessage(),e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上就是java使用redis的基础用法，我不是运维，具体redis配置，集群暂不考虑。</p>
<p>更新 - 2018-07-30</p>
<p>很久之前就借鉴了网上的代码做了一个Redis库，但后期没时间完成更复杂的部分，在这边分享一下。</p>
<p>首先入口是这个类，很简单的构建了一个工厂，生成RedisClient对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RedisClient redisClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> RedisClient <span class="title">singletonBuild</span><span class="params">(String ip,<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (redisClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisClient = <span class="keyword">new</span> RedisClient(ip, port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RedisClient <span class="title">build</span><span class="params">(String ip,<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">new</span> RedisClient(ip, port);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RedisSentinelClient <span class="title">build</span><span class="params">(String masterName,Set&lt;String&gt; sentinels)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisSentinelClient(masterName,sentinels,<span class="keyword">new</span> JedisPoolConfig());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setSerializeClass</span><span class="params">(Class cls)</span></span>&#123;</span><br><span class="line">        ProtostuffUtils.registerWrapperClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实RedisClient就是封装了一些Jedis的方法，但在这里，做了一个优化，原Jedis的方法需要自己实现序列化，RedisClient这个类包装的方法会有个万能Reids序列化的工具。</p>
<p>这个类大概是这个样子的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> maxTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> maxIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> maxWaitMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> testOnBorrow;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> (<span class="keyword">final</span> InputStream stream = RedisClient.class.getClassLoader().getResourceAsStream(<span class="string">"cache.properties"</span>)) &#123;</span><br><span class="line">            properties.load(stream);</span><br><span class="line">            maxTotal = Integer.parseInt(properties.getProperty(<span class="string">"common.redis.maxTotal"</span>,<span class="string">"1000"</span>));</span><br><span class="line">            maxIdle = Integer.parseInt(properties.getProperty(<span class="string">"common.redis.maxIdle"</span>,<span class="string">"100"</span>));</span><br><span class="line">            maxWaitMillis = Integer.parseInt(properties.getProperty(<span class="string">"common.redis.maxWaitMillis"</span>,<span class="string">"10000"</span>));</span><br><span class="line">            testOnBorrow = Boolean.parseBoolean(properties.getProperty(<span class="string">"common.redis.testOnBorrow"</span>,<span class="string">"true"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//配置最大jedis实例数</span></span><br><span class="line">        config.setMaxTotal(maxTotal);</span><br><span class="line">        <span class="comment">//配置资源池最大闲置数</span></span><br><span class="line">        config.setMaxIdle(maxIdle);</span><br><span class="line">        <span class="comment">//等待可用连接的最大时间</span></span><br><span class="line">        config.setMaxWaitMillis(maxWaitMillis);</span><br><span class="line">        <span class="comment">//在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的</span></span><br><span class="line">        config.setTestOnBorrow(testOnBorrow);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisClient</span><span class="params">(String ip,<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(ip,port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putData</span><span class="params">(String redisKey,Object param)</span></span>&#123;</span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] serialize = ProtostuffUtils.serialize(param);</span><br><span class="line">            String result = jedis.setex(redisKey.getBytes(), <span class="number">60</span> * <span class="number">60</span> * <span class="number">60</span>, serialize);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result!= <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Put object exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedisPool.returnResource(jedis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getData</span><span class="params">(String redisKey,Class cla)</span></span>&#123;</span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = jedis.get(redisKey.getBytes());</span><br><span class="line">            Object deserialize = ProtostuffUtils.deserialize(bytes, cla);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (deserialize!= <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> (T) deserialize;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Get object exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedisPool.returnResource(jedis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">publishMessage</span><span class="params">(String channel,String msg)</span></span>&#123;</span><br><span class="line">       Jedis jedis = jedisPool.getResource();</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           Long publishCount = jedis.publish(channel, msg);</span><br><span class="line">           System.out.println(<span class="string">"发送成功，该频道有"</span> +publishCount + <span class="string">"个订阅者"</span>);</span><br><span class="line">       &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">               jedisPool.returnResource(jedis);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeMessage</span><span class="params">(JedisPubSub pubSub, String channel)</span></span>&#123;</span><br><span class="line">       Jedis jedis = jedisPool.getResource();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           jedis.subscribe(pubSub, channel);</span><br><span class="line">       &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">               jedisPool.returnResource(jedis);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略更多方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里面有两个方法要说明一下，[publishMessage]、[subscribeMessage]。<br>Redis可以作为Mq做广播和接收，但这种方法并非安全<br>分布式队列的应用场景和缓存的应用场景是不一样的。<br>如果有没来得及持久化的数据怎么办？<br>从业务系统的角度，已经成功发送给消息队列了。<br>消息队列也以为Redis妥妥地收好了。<br>可Redis还没写到日记里，更没有及时通知小伙伴，挂了。可能是断电了，可能是进程被kill了。<br>后果会怎样？<br>已经执行过的任务会再次执行一遍。<br>已经放到队列中的任务，消失了。<br>标记为已经完成的任务，状态变为“进行中”了，然后又被执行了一遍。<br>后果不可接受。</p>
<p>所以如果使用这两个方法，一定要做好相应的措施，例如：<br>采用 Master－Slave 数据复制模式，配置bgsave，追加存储到aof。<br>在从服务器上配置bgsave，不影响master性能。</p>
<p>之后一个很重要的类就是序列化工具类，使用Protostuff<br>众所周知吧，Protostuff是一个很厉害的序列化工具，这里对Protostuff做一个包装。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtostuffUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要使用包装类进行序列化/反序列化的class集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; WRAPPER_SET = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化/反序列化包装类 Class 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;SerializeDeserializeWrapper&gt; WRAPPER_CLASS = SerializeDeserializeWrapper.class;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化/反序列化包装类 Schema 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Schema&lt;SerializeDeserializeWrapper&gt; WRAPPER_SCHEMA = RuntimeSchema.createFrom(WRAPPER_CLASS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存对象及对象schema信息集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt; CACHE_SCHEMA = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 预定义一些Protostuff无法直接序列化/反序列化的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        WRAPPER_SET.add(List.class);</span><br><span class="line">        WRAPPER_SET.add(ArrayList.class);</span><br><span class="line">        WRAPPER_SET.add(Map.class);</span><br><span class="line">	    WRAPPER_SET.add(HashMap.class);</span><br><span class="line">        WRAPPER_SET.add(Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册需要使用包装类进行序列化/反序列化的 Class 对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cls 需要包装的类型 Class 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerWrapperClass</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">        WRAPPER_SET.add(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取序列化对象类型的schema</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cls 序列化对象的class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 序列化对象的类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 序列化对象类型的schema</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Schema&lt;T&gt; <span class="title">getSchema</span><span class="params">(Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line">        Schema&lt;T&gt; schema = (Schema&lt;T&gt;) CACHE_SCHEMA.get(cls);</span><br><span class="line">        <span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</span><br><span class="line">            schema = RuntimeSchema.createFrom(cls);</span><br><span class="line">            CACHE_SCHEMA.put(cls, schema);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> schema;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj 需要序列化的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 序列化对象的类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 序列化后的二进制数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">byte</span>[] serialize(T obj) &#123;</span><br><span class="line">        Class&lt;T&gt; clazz = (Class&lt;T&gt;) obj.getClass();</span><br><span class="line">        LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object serializeObject = obj;</span><br><span class="line">            Schema schema = WRAPPER_SCHEMA;</span><br><span class="line">            <span class="keyword">if</span> (!WRAPPER_SET.contains(clazz)) &#123;</span><br><span class="line">                schema = getSchema(clazz);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serializeObject = SerializeDeserializeWrapper.builder(obj);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ProtostuffIOUtil.toByteArray(serializeObject, schema, buffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data  需要反序列化的二进制数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 反序列化后的对象class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;   反序列化后的对象类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 反序列化后的对象集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] data, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!WRAPPER_SET.contains(clazz)) &#123;</span><br><span class="line">                T message = clazz.newInstance();</span><br><span class="line">                Schema&lt;T&gt; schema = getSchema(clazz);</span><br><span class="line">                ProtostuffIOUtil.mergeFrom(data, message, schema);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                SerializeDeserializeWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> SerializeDeserializeWrapper&lt;&gt;();</span><br><span class="line">                ProtostuffIOUtil.mergeFrom(data, wrapper, WRAPPER_SCHEMA);</span><br><span class="line">                <span class="keyword">return</span> wrapper.getData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个项目我已经放到GitHUb上了 <a href="https://github.com/RadianceL/RedisPlugin" target="_blank" rel="noopener">地址</a></p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Redis/">Redis</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/04/05/Jenkins/" data-tooltip="jenkins" aria-label="PREVIOUS: jenkins">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/12/28/C-Pointer/" data-tooltip="C-Pointer" aria-label="NEXT: C-Pointer">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Eddie Lee. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/04/05/Jenkins/" data-tooltip="jenkins" aria-label="PREVIOUS: jenkins">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/12/28/C-Pointer/" data-tooltip="C-Pointer" aria-label="NEXT: C-Pointer">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/eddie-personal.jpg" alt="Author&#39;s picture">
        
            <h4 id="about-card-name">Eddie Lee</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                LN
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->

    



    </body>
</html>
