
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog Bom!!BO!">
    <title>Kafka note - Blog Bom!!BO!</title>
    <meta name="author" content="Eddie Lee">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eddie Lee","sameAs":["https://github.com/RadianceL"],"image":"alan-walker.jpg"},"articleBody":"之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。\n\nkafka 是什么官网上指出”A Distributed Streaming Platform”，一个分布式的流处理平台\n\nPUBLISH &amp; SUBSCRIBE     发布和订阅\nPROCESS                处理\nSTORE                      贮存\n\n流处理具体是什么含义相信大家都理解，毕竟一个java工程师对Linux和C一定是很熟悉的。那么kafka三大功能都是什么含义呢？\nPUBLISH &amp; SUBSCRIBEe.g.我们开车通常会听广播，那广播是从广播电台统一发布那我们接受广播，只需要打开收音机，订阅广播即可听到这个声音那么这个关系，就是发布和订阅的关系，一端发出，一端订阅\n对应到kafka中的概念，就是\n\nProducer    生产发布\nConsumer    消费订阅\n\nPROCESS编写可扩展的流处理应用程序，用于实时事件响应的场景。一开始我们看到kafka定位为“一个分布式的流处理平台”既然是流处理，那处理必然是一个很关键的一点e.g. 一个秒杀活动，并发量特别大，并发量大的时候，可能会有大量用户同时提交付款，但我们的服务器可能无法承载这么多并发，那我们采用延时订阅等方式，以达到可以处理历史数据的应用程序\nSTORE安全的将流式的数据存储在一个分布式，有副本备份，容错的集群。这个概念比较简单了，意思是这个数据是有备份的，你有几个集群，这个数据就会被备份几份，比如说你有总容量600G的3台主机建立了3个kafka集群，那么实际有效存储只有200G，这是因为每个数据都会被同时备份到另外两台主机中，以保证数据不会丢失，利用空间换取稳定。同时这个集群是一个容错的集群，后期我会做这个容错测试，让自己也能更放心大胆的用kafka。在这里延伸两个名词\n\nTopic        Kafka将消息种子(Feed)分门别类，每一类的消息称之为一个主题(Topic).\nBroker    已发布的消息保存在一组服务器中，称之为Kafka集群。集群中的每一个服务器都是一个代理(Broker). 消费者可以订阅一个或多个主题（topic），并从Broker拉数据，从而消费这些已发布的消息。\n\n\n那么以上就是kafka的官网概念回顾。总体来讲只要接触过集群，分布式，微服务的概念，理解这些应该是非常非常简单的总之kafka有四个小概念，Producer,Consumer,Topic,Broker那么根据这四个概念，我们简单建立一个消息系统模型\n工厂A 每分钟生产馒头5个        —为工厂A建立 Topic FactoryA工厂B 每分钟生产窝头1个        —为工厂B建立 Topic FactoryB那么两个工厂每分钟都会发布一个消息到各自的主题（Topic）中为了保证工厂发布渠道的稳定性，那两个工厂合资创建了3个销售渠道Broker0，Broker1，Broker2因为工厂每分钟总共就生产出固定的馒头，不会因为某个销售渠道卖的多而增加产量，所有这三个渠道之间的库存数据（待消费数据）是同步的此时客户来了，客户可能只想吃馒头，那他只订阅FactoryA，那么FactoryB的数据就不会给这个客户，而客户也并不关心是哪个销售渠道提供的，他只关心最后送来的东西是工厂A生产的馒头，就OK了。如果客户比较能吃（服务器承载量大），那他可以订阅两个Topic，一起处理\n这种就是我们的消息系统的实际应用场景ps: 官网上提供了很完整的下载，启动，测试的方法，这个笔记中不做记录，想练回头看下官网的Quick Start即可，同时安利一个中文版的国内网站，翻译的有些偏差，不过也非常棒，减少了我的一些阅读障碍\nkafka重要配置项1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253############################# Server Basics ############################## 核心配置broker.id=0############################# Socket Server Settings ############################## 监听端口listeners=PLAINTEXT://:9092# 配置服务提供远端访问能力advertised.listeners=PLAINTEXT://47.96.29.8:9092# 配置Https的连接 没用到 比较复杂#listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL# server用来处理网络请求的网络线程数目；一般你不需要更改这个属性。num.network.threads=3# server用来处理请求的I/O线程的数目；这个线程数目至少要等于硬盘的个数。num.io.threads=8# SO_SNDBUFF 缓存大小，server进行socket 连接所用socket.send.buffer.bytes=102400# SO_RCVBUFF缓存大小，server进行socket连接时所用socket.receive.buffer.bytes=102400# server允许的最大请求尺寸；  这将避免server溢出，它应该小于Java heap sizesocket.request.max.bytes=10485760############################# Log Basics ############################## 此目录每次重启会被清理，测试用就不改了log.dirs=/tmp/kafka-logs# 如果创建topic时没有给出划分partitions个数，这个数字将是topic下partitions数目的默认数值。num.partitions=1num.recovery.threads.per.data.dir=1############################# Internal Topic Settings  #############################offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1############################# Log Flush Policy ############################## The number of messages to accept before forcing a flush of data to disk#log.flush.interval.messages=10000# The maximum amount of time a message can sit in a log before we force a flush#log.flush.interval.ms=1000############################# Log Retention Policy #############################log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000############################# Zookeeper #############################zookeeper.connect=localhost:2181# Timeout in ms for connecting to zookeeperzookeeper.connection.timeout.ms=6000############################# Group Coordinator Settings #############################group.initial.rebalance.delay.ms=0\nKafka启动\n首先下载kafkawget http://mirror.bit.edu.cn/apache/kafka/2.1.0/kafka_2.11-2.1.0.tgz\n解压tar -xzf kafka_2.11-2.1.0.tgz\n进入kafka目录，开始配置(最好复制一份比如server-1.properties)vim ~/{kafka}/config/server.properties\n启动zookeeper，不建议使用kafka自带的zookeeper，我在另一台机器起了一台需要先拷贝一份默认配置并修改配置，然后重命名为zoo.cfgnohup ./zkServer.sh &gt; /root/log/zookeeper-1.log 2&gt;&amp;1 &amp;\n启动kafkabin/kafka-server-start.sh config/server.properties\n启动监听bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic xxxx --from-beginning\n\n至此，kafka启动完毕，第六部可以不使用，但调试非常有帮助，可以看到你的信息是否成功发送到服务器上\n使用kafka java API说了一大堆，没实战就是耍流氓，现在起开始正式进入编码阶段。首先，Jar包是肯定的了，此时我会选用最新版本的jar包，毕竟是测试联系，不会太计较稳定性，也想通过新版本的一些坑对比老版本。12345&lt;dependency&gt;    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;    &lt;artifactId&gt;kafka_2.12&lt;/artifactId&gt;    &lt;version&gt;2.0.0&lt;/version&gt;&lt;/dependency&gt;\n仔细看了官网的文档，发现生产和消费，貌似用的同一个Jar包？先试试看吧，回头有问题再改。\n剩下的我们来看下kafka的代码，首先是一个生产者的类 –请忽略我非常不要脸的把自己名放到类名里了 实在没啥好名字 也为了防止冲突✌️1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556/** * @author eddie * @createTime 2018-11-08 * @description 生产者 */public class EddieProducer extends ShutdownableThread &#123;    private Queue&lt;Message&gt; queue;    private KafkaProducer&lt;String, String&gt; producer;    private String topic;    private boolean shutdown = false;    public EddieProducer(final String topic, final KafkaProducer&lt;String, String&gt; producer)&#123;        super(\"\", false);        queue = new ConcurrentLinkedQueue&lt;&gt;();        this.topic = topic;        this.producer = producer;    &#125;    public boolean add(Message e)&#123;        return queue.add(e);    &#125;    public boolean add(Collection&lt;? extends Message&gt; collection)&#123;        return queue.addAll(collection);    &#125;    @Override    public void doWork() &#123;        while (!shutdown &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;            if (!queue.isEmpty()) &#123;                long startTime = System.currentTimeMillis();                Message message = Objects.requireNonNull(queue.poll());                String key = message.getKey();                String value = message.getValue();                Future&lt;RecordMetadata&gt; send = producer.send(                        new ProducerRecord&lt;&gt;(topic, key, value),                        new ProducerCallBack(startTime, key, value)                );            &#125;            try &#123;                Thread.sleep(300);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;    &#125;    public void cancel() &#123;        shutdown = true;        Thread.currentThread().interrupt();    &#125;&#125;\n可以看到上面我们用了一个回调ProducerCallBack，这个东西其实是自己定义的，根据配置，目前是当kafka服务器成功写入一个主机（broker）中就返回，返回后回调这个类的onCompletion方法123456789101112131415161718192021222324252627/** * @author eddie * @createTime 2018-11-08 * @description 回调函数 */public class ProducerCallBack implements Callback &#123;    private final long startTime;    private final String key;    private final String message;    public ProducerCallBack(long startTime, String key, String message) &#123;        this.startTime = startTime;        this.key = key;        this.message = message;    &#125;    @Override    public void onCompletion(RecordMetadata metadata, Exception exception) &#123;        long elapsedTime = System.currentTimeMillis() - startTime;        if (metadata != null) &#123;            System.out.printf(\"message(%s, %s) sent to partition(%d), offset(%d) in %d ms%n\",                    key, message, metadata.partition(), metadata.offset(), elapsedTime);        &#125; else &#123;            exception.printStackTrace();        &#125;    &#125;&#125;\n再来看下消费者类，消费者稍微有点复杂，这里面有个偏移量的概念，这个概念我理解是可以随意访问历史量的重要参数，我这一些配置放到了另外一个配置工厂里了，不过因为有些问题我也不是很清楚，所以慢慢成长，这个小工具完整的实现在github上，文末有链接1234567891011121314151617181920212223242526272829303132333435363738/** * @author eddie * @createTime 2018-11-08 * @description */public class EddieConsumer extends ShutdownableThread &#123;    private String topic;    private KafkaConsumer consumer;    public EddieConsumer(final String topic, final KafkaConsumer&lt;String, String&gt; producer)&#123;        super(\"KafkaConsumerExample\", false);        this.topic = topic;        this.consumer = producer;    &#125;    @Override    public void doWork() &#123;        consumer.subscribe(Collections.singletonList(this.topic));        ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofSeconds(3));        int count = records.count();        System.out.println( \"测试结果\" + count);        for (ConsumerRecord&lt;String, String&gt; record : records) &#123;            System.out.println(\"Received message: (\" + record.key() + \", \" + record.value() + \") at offset \" + record.offset());        &#125;    &#125;    @Override    public String name() &#123;        return \"KafkaConsumerExample\";    &#125;    @Override    public boolean isInterruptible() &#123;        return Thread.currentThread().isInterrupted();    &#125;&#125;\n通过以上的代码，我们实现了发布数据到远端，实时拿到数据。最后看下调用的代码：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * @author eddie * @createTime 2018-11-08 * @description 测试类 */public class MainTest &#123;    public static void main(String[] args)&#123;        //生成地址池        List&lt;KafkaUrlNode&gt; list = new ArrayList&lt;&gt;();        list.add(new KafkaUrlNode(\"47.96.29.8\", \"9092\"));        //构造一个配置对象        KafkaProducerConfig config = new KafkaProducerConfig();        //里面配置很多 但我写了很多默认配置 除了这个地址池，其他选默认没有关系 可以满足大部分需求了        config.setUrlNodeList(list);        //我比较迷恋的工厂模式        KafkaProducer producer = KafkaFactory.create()                .init(config)                .setSerializerKeyAndValueType(TypeDefine.STRING, TypeDefine.STRING)                .buildKafkaProducer();        //通过工厂模式生产出来的，就是非常标准的KafkaProducer 但这个使用起来并不那么顺手        //所以我又封装了一个EddieProducer 开线程来处理生产和消费        EddieProducer eddieProducer = new EddieProducer(\"test\", producer);        //开启线程        eddieProducer.start();        //添加数据        eddieProducer.add(new Message(\"a\", \"b\"));        eddieProducer.add(new Message(\"a\", \"b\"));        eddieProducer.add(new Message(\"a\", \"b\"));        eddieProducer.add(new Message(\"a\", \"b\"));        eddieProducer.add(new Message(\"a\", \"b\"));        eddieProducer.add(new Message(\"a\", \"b\"));        //一个关掉线程的小工具 写的非常简易 不过胜在安全        ThreadShutdown.finishThread(eddieProducer);        System.out.println(\"测试\");        KafkaConsumerConfig conmuserConfig = new KafkaConsumerConfig();        conmuserConfig.setUrlNodeList(list);        conmuserConfig.setGroupId(\"test\");        KafkaConsumer consumer = KafkaFactory.create()                .init(conmuserConfig)                .setDeserializerKeyAndValueType(TypeDefine.DE_STRING, TypeDefine.DE_STRING)                .buildKafkaConmuser();        EddieConsumer eddieConsumer = new EddieConsumer(\"test\", consumer);        eddieConsumer.start();    &#125;&#125;\n总的来说，我个人觉得kafka学习的主要难度在于只有官网可查，网上很多资料要不太老，要么根本就是个超简单东西摆在那，一点实际价值都没得。所以搞这么一个博客，记录自己的学习笔记，省着忘了。GitHUb\n然后最后感谢 Java高端交流群一 中的  Κёлτ &amp;&amp; 那一天，通过与他们讨论，解决了我很多问题，包括线程底层原理的部分。\n","dateCreated":"2018-11-07T09:33:46+08:00","dateModified":"2018-12-11T17:17:17+08:00","datePublished":"2018-11-07T09:33:46+08:00","description":"之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。","headline":"Kafka note","image":["https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&fm=27&gp=0.jpg","http://pic.paopaoche.net/up/2015-11/201511101726368467375.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://radiancel.github.io/2018/11/07/Kafka-note/"},"publisher":{"@type":"Organization","name":"Eddie Lee","sameAs":["https://github.com/RadianceL"],"image":"alan-walker.jpg","logo":{"@type":"ImageObject","url":"alan-walker.jpg"}},"url":"https://radiancel.github.io/2018/11/07/Kafka-note/","keywords":"Middleware","thumbnailUrl":"https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&fm=27&gp=0.jpg"}</script>
    <meta name="description" content="之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。">
<meta name="keywords" content="Middleware">
<meta property="og:type" content="blog">
<meta property="og:title" content="Kafka note">
<meta property="og:url" content="https://radiancel.github.io/2018/11/07/Kafka-note/index.html">
<meta property="og:site_name" content="Blog Bom!!BO!">
<meta property="og:description" content="之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-12-11T09:17:17.028Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka note">
<meta name="twitter:description" content="之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。">
    
    
        
    
    
        <meta property="og:image" content="https://radiancel.github.io/assets/images/alan-walker.jpg"/>
    
    
        <meta property="og:image" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&amp;fm=27&amp;gp=0.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=960265520,2932106354&amp;fm=27&amp;gp=0.jpg" />
    
    
        <meta property="og:image" content="http://pic.paopaoche.net/up/2015-11/201511101726368467375.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://pic.paopaoche.net/up/2015-11/201511101726368467375.jpg" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-du2xmrqdqrl2ollgeiw050kpl6l4nbyz7bumjuurjgsxyopifvukebxc9lqe.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Blog Bom!!BO!</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/alan-walker.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/alan-walker.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Eddie Lee</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Once work as assistant teacher, and now in LN bld Technology Co. Ltd</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/RadianceL" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    "
             style="background-image:url('http://pic.paopaoche.net/up/2015-11/201511101726368467375.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Kafka note
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-11-07T09:33:46+08:00">
	
		    Nov 07, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java/">Java</a>


    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>之前我想要把数据结构写完，再来写这些乱七八糟的东西。不过最近一段时间工作比较忙，加上未来涉及到中间件的使用，回头还是先把中间件的理解先放在前面吧，数据结构这块不会烂尾的。</p>
<a id="more"></a>
<h1 id="kafka-是什么"><a href="#kafka-是什么" class="headerlink" title="kafka 是什么"></a>kafka 是什么</h1><p>官网上指出”A Distributed Streaming Platform”，一个分布式的流处理平台</p>
<ul>
<li>PUBLISH &amp; SUBSCRIBE     发布和订阅</li>
<li>PROCESS                处理</li>
<li>STORE                      贮存</li>
</ul>
<p>流处理具体是什么含义相信大家都理解，毕竟一个java工程师对Linux和C一定是很熟悉的。<br>那么kafka三大功能都是什么含义呢？</p>
<h2 id="PUBLISH-amp-SUBSCRIBE"><a href="#PUBLISH-amp-SUBSCRIBE" class="headerlink" title="PUBLISH &amp; SUBSCRIBE"></a>PUBLISH &amp; SUBSCRIBE</h2><p>e.g.<br>我们开车通常会听广播，那广播是从广播电台统一发布<br>那我们接受广播，只需要打开收音机，订阅广播即可听到这个声音<br>那么这个关系，就是发布和订阅的关系，一端发出，一端订阅</p>
<p>对应到kafka中的概念，就是</p>
<ul>
<li>Producer    生产发布</li>
<li>Consumer    消费订阅</li>
</ul>
<h2 id="PROCESS"><a href="#PROCESS" class="headerlink" title="PROCESS"></a>PROCESS</h2><p>编写可扩展的流处理应用程序，用于实时事件响应的场景。一开始我们看到kafka定位为“一个分布式的流处理平台”<br>既然是流处理，那处理必然是一个很关键的一点<br>e.g. 一个秒杀活动，并发量特别大，并发量大的时候，可能会有大量用户同时提交付款，但我们的服务器可能无法承载这么多并发，那我们采用延时订阅等方式，以达到可以处理历史数据的应用程序</p>
<h2 id="STORE"><a href="#STORE" class="headerlink" title="STORE"></a>STORE</h2><p>安全的将流式的数据存储在一个分布式，有副本备份，容错的集群。<br>这个概念比较简单了，意思是这个数据是有备份的，你有几个集群，这个数据就会被备份几份，比如说你有总容量600G的3台主机建立了3个kafka集群，那么实际有效存储只有200G，这是因为每个数据都会被同时备份到另外两台主机中，以保证数据不会丢失，利用空间换取稳定。同时这个集群是一个容错的集群，后期我会做这个容错测试，让自己也能更放心大胆的用kafka。<br>在这里延伸两个名词</p>
<ul>
<li>Topic        Kafka将消息种子(Feed)分门别类，每一类的消息称之为一个主题(Topic).</li>
<li>Broker    已发布的消息保存在一组服务器中，称之为Kafka集群。集群中的每一个服务器都是一个代理(Broker). 消费者可以订阅一个或多个主题（topic），并从Broker拉数据，从而消费这些已发布的消息。</li>
</ul>
<hr>
<p>那么以上就是kafka的官网概念回顾。总体来讲只要接触过集群，分布式，微服务的概念，理解这些应该是非常非常简单的<br>总之kafka有四个小概念，<code>Producer</code>,<code>Consumer</code>,<code>Topic</code>,<code>Broker</code><br>那么根据这四个概念，我们简单建立一个消息系统模型</p>
<p>工厂A 每分钟生产馒头5个        —为工厂A建立 Topic FactoryA<br>工厂B 每分钟生产窝头1个        —为工厂B建立 Topic FactoryB<br>那么两个工厂每分钟都会发布一个消息到各自的主题（Topic）中<br>为了保证工厂发布渠道的稳定性，那两个工厂合资创建了3个销售渠道Broker0，Broker1，Broker2<br>因为工厂每分钟总共就生产出固定的馒头，不会因为某个销售渠道卖的多而增加产量，所有这三个渠道之间的库存数据（待消费数据）是同步的<br>此时客户来了，客户可能只想吃馒头，那他只订阅FactoryA，那么FactoryB的数据就不会给这个客户，而客户也并不关心是哪个销售渠道提供的，他只关心最后送来的东西是工厂A生产的馒头，就OK了。<br>如果客户比较能吃（服务器承载量大），那他可以订阅两个Topic，一起处理</p>
<p>这种就是我们的消息系统的实际应用场景<br>ps: 官网上提供了很完整的下载，启动，测试的方法，这个笔记中不做记录，想练回头看下官网的Quick Start即可，同时安利一个中文版的国内<a href="http://orchome.com/kafka/index" target="_blank" rel="noopener">网站</a>，翻译的有些偏差，不过也非常棒，减少了我的一些阅读障碍</p>
<h2 id="kafka重要配置项"><a href="#kafka重要配置项" class="headerlink" title="kafka重要配置项"></a>kafka重要配置项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">############################# Server Basics #############################</span><br><span class="line"># 核心配置</span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line">############################# Socket Server Settings #############################</span><br><span class="line"># 监听端口</span><br><span class="line">listeners=PLAINTEXT://:9092</span><br><span class="line"># 配置服务提供远端访问能力</span><br><span class="line">advertised.listeners=PLAINTEXT://47.96.29.8:9092</span><br><span class="line"># 配置Https的连接 没用到 比较复杂</span><br><span class="line">#listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span><br><span class="line"># server用来处理网络请求的网络线程数目；一般你不需要更改这个属性。</span><br><span class="line">num.network.threads=3</span><br><span class="line"># server用来处理请求的I/O线程的数目；这个线程数目至少要等于硬盘的个数。</span><br><span class="line">num.io.threads=8</span><br><span class="line"># SO_SNDBUFF 缓存大小，server进行socket 连接所用</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"># SO_RCVBUFF缓存大小，server进行socket连接时所用</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"># server允许的最大请求尺寸；  这将避免server溢出，它应该小于Java heap size</span><br><span class="line">socket.request.max.bytes=10485760</span><br><span class="line"></span><br><span class="line">############################# Log Basics #############################</span><br><span class="line"># 此目录每次重启会被清理，测试用就不改了</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line"># 如果创建topic时没有给出划分partitions个数，这个数字将是topic下partitions数目的默认数值。</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line">############################# Internal Topic Settings  #############################</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"></span><br><span class="line">############################# Log Flush Policy #############################</span><br><span class="line"># The number of messages to accept before forcing a flush of data to disk</span><br><span class="line">#log.flush.interval.messages=10000</span><br><span class="line"># The maximum amount of time a message can sit in a log before we force a flush</span><br><span class="line">#log.flush.interval.ms=1000</span><br><span class="line"></span><br><span class="line">############################# Log Retention Policy #############################</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">############################# Zookeeper #############################</span><br><span class="line">zookeeper.connect=localhost:2181</span><br><span class="line"># Timeout in ms for connecting to zookeeper</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line"></span><br><span class="line">############################# Group Coordinator Settings #############################</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>
<h2 id="Kafka启动"><a href="#Kafka启动" class="headerlink" title="Kafka启动"></a>Kafka启动</h2><ol>
<li>首先下载kafka<br><code>wget http://mirror.bit.edu.cn/apache/kafka/2.1.0/kafka_2.11-2.1.0.tgz</code></li>
<li>解压<br><code>tar -xzf kafka_2.11-2.1.0.tgz</code></li>
<li>进入kafka目录，开始配置(最好复制一份比如server-1.properties)<br><code>vim ~/{kafka}/config/server.properties</code></li>
<li>启动zookeeper，不建议使用kafka自带的zookeeper，我在另一台机器起了一台<br>需要先拷贝一份默认配置并修改配置，然后重命名为zoo.cfg<br><code>nohup ./zkServer.sh &gt; /root/log/zookeeper-1.log 2&gt;&amp;1 &amp;</code></li>
<li>启动kafka<br><code>bin/kafka-server-start.sh config/server.properties</code></li>
<li>启动监听<br><code>bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic xxxx --from-beginning</code></li>
</ol>
<p>至此，kafka启动完毕，第六部可以不使用，但调试非常有帮助，可以看到你的信息是否成功发送到服务器上</p>
<h2 id="使用kafka-java-API"><a href="#使用kafka-java-API" class="headerlink" title="使用kafka java API"></a>使用kafka java API</h2><p>说了一大堆，没实战就是耍流氓，现在起开始正式进入编码阶段。<br>首先，Jar包是肯定的了，此时我会选用最新版本的jar包，毕竟是测试联系，不会太计较稳定性，也想通过新版本的一些坑对比老版本。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>仔细看了官网的文档，发现生产和消费，貌似用的同一个Jar包？先试试看吧，回头有问题再改。</p>
<p>剩下的我们来看下kafka的代码，首先是一个生产者的类 –请忽略我非常不要脸的把自己名放到类名里了 实在没啥好名字 也为了防止冲突✌️<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> eddie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2018-11-08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EddieProducer</span> <span class="keyword">extends</span> <span class="title">ShutdownableThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;Message&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> KafkaProducer&lt;String, String&gt; producer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> shutdown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EddieProducer</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> KafkaProducer&lt;String, String&gt; producer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">""</span>, <span class="keyword">false</span>);</span><br><span class="line">        queue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.topic = topic;</span><br><span class="line">        <span class="keyword">this</span>.producer = producer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Message e)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queue.add(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Collection&lt;? extends Message&gt; collection)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queue.addAll(collection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!shutdown &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">                Message message = Objects.requireNonNull(queue.poll());</span><br><span class="line">                String key = message.getKey();</span><br><span class="line">                String value = message.getValue();</span><br><span class="line">                Future&lt;RecordMetadata&gt; send = producer.send(</span><br><span class="line">                        <span class="keyword">new</span> ProducerRecord&lt;&gt;(topic, key, value),</span><br><span class="line">                        <span class="keyword">new</span> ProducerCallBack(startTime, key, value)</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shutdown = <span class="keyword">true</span>;</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到上面我们用了一个回调<code>ProducerCallBack</code>，这个东西其实是自己定义的，根据配置，目前是当kafka服务器成功写入一个主机（broker）中就返回，返回后回调这个类的onCompletion方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> eddie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2018-11-08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerCallBack</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProducerCallBack</span><span class="params">(<span class="keyword">long</span> startTime, String key, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.printf(<span class="string">"message(%s, %s) sent to partition(%d), offset(%d) in %d ms%n"</span>,</span><br><span class="line">                    key, message, metadata.partition(), metadata.offset(), elapsedTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再来看下消费者类，消费者稍微有点复杂，这里面有个偏移量的概念，这个概念我理解是可以随意访问历史量的重要参数，我这一些配置放到了另外一个配置工厂里了，不过因为有些问题我也不是很清楚，所以慢慢成长，这个小工具完整的实现在github上，文末有链接<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> eddie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2018-11-08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EddieConsumer</span> <span class="keyword">extends</span> <span class="title">ShutdownableThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> KafkaConsumer consumer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EddieConsumer</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> KafkaConsumer&lt;String, String&gt; producer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"KafkaConsumerExample"</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.topic = topic;</span><br><span class="line">        <span class="keyword">this</span>.consumer = producer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="keyword">this</span>.topic));</span><br><span class="line">        ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofSeconds(<span class="number">3</span>));</span><br><span class="line">        <span class="keyword">int</span> count = records.count();</span><br><span class="line">        System.out.println( <span class="string">"测试结果"</span> + count);</span><br><span class="line">        <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Received message: ("</span> + record.key() + <span class="string">", "</span> + record.value() + <span class="string">") at offset "</span> + record.offset());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"KafkaConsumerExample"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterruptible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().isInterrupted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上的代码，我们实现了发布数据到远端，实时拿到数据。<br>最后看下调用的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> eddie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2018-11-08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//生成地址池</span></span><br><span class="line">        List&lt;KafkaUrlNode&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> KafkaUrlNode(<span class="string">"47.96.29.8"</span>, <span class="string">"9092"</span>));</span><br><span class="line">        <span class="comment">//构造一个配置对象</span></span><br><span class="line">        KafkaProducerConfig config = <span class="keyword">new</span> KafkaProducerConfig();</span><br><span class="line">        <span class="comment">//里面配置很多 但我写了很多默认配置 除了这个地址池，其他选默认没有关系 可以满足大部分需求了</span></span><br><span class="line">        config.setUrlNodeList(list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//我比较迷恋的工厂模式</span></span><br><span class="line">        KafkaProducer producer = KafkaFactory.create()</span><br><span class="line">                .init(config)</span><br><span class="line">                .setSerializerKeyAndValueType(TypeDefine.STRING, TypeDefine.STRING)</span><br><span class="line">                .buildKafkaProducer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过工厂模式生产出来的，就是非常标准的KafkaProducer 但这个使用起来并不那么顺手</span></span><br><span class="line">        <span class="comment">//所以我又封装了一个EddieProducer 开线程来处理生产和消费</span></span><br><span class="line">        EddieProducer eddieProducer = <span class="keyword">new</span> EddieProducer(<span class="string">"test"</span>, producer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启线程</span></span><br><span class="line">        eddieProducer.start();</span><br><span class="line">        <span class="comment">//添加数据</span></span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line">        eddieProducer.add(<span class="keyword">new</span> Message(<span class="string">"a"</span>, <span class="string">"b"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//一个关掉线程的小工具 写的非常简易 不过胜在安全</span></span><br><span class="line">        ThreadShutdown.finishThread(eddieProducer);</span><br><span class="line">        System.out.println(<span class="string">"测试"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        KafkaConsumerConfig conmuserConfig = <span class="keyword">new</span> KafkaConsumerConfig();</span><br><span class="line">        conmuserConfig.setUrlNodeList(list);</span><br><span class="line">        conmuserConfig.setGroupId(<span class="string">"test"</span>);</span><br><span class="line">        KafkaConsumer consumer = KafkaFactory.create()</span><br><span class="line">                .init(conmuserConfig)</span><br><span class="line">                .setDeserializerKeyAndValueType(TypeDefine.DE_STRING, TypeDefine.DE_STRING)</span><br><span class="line">                .buildKafkaConmuser();</span><br><span class="line">        EddieConsumer eddieConsumer = <span class="keyword">new</span> EddieConsumer(<span class="string">"test"</span>, consumer);</span><br><span class="line">        eddieConsumer.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总的来说，我个人觉得kafka学习的主要难度在于只有官网可查，网上很多资料要不太老，要么根本就是个超简单东西摆在那，一点实际价值都没得。所以搞这么一个博客，记录自己的学习笔记，省着忘了。<br><a href="https://github.com/RadianceL/kafka-plugins" target="_blank" rel="noopener">GitHUb</a></p>
<p>然后最后感谢 Java高端交流群一 中的  <code>Κёлτ</code> &amp;&amp; <code>那一天</code>，通过与他们讨论，解决了我很多问题，包括线程底层原理的部分。</p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Middleware/">Middleware</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/11/20/Your-Story/" data-tooltip="Your Story break the ice" aria-label="PREVIOUS: Your Story break the ice">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/10/19/Https/" data-tooltip="Https" aria-label="NEXT: Https">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Eddie Lee. All Rights Reserved.
    </span>
</footer>
            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/11/20/Your-Story/" data-tooltip="Your Story break the ice" aria-label="PREVIOUS: Your Story break the ice">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/10/19/Https/" data-tooltip="Https" aria-label="NEXT: Https">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <i id="btn-close-shareoptions" class="fa fa-times"></i>
    <ul class="share-options">
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/alan-walker.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Eddie Lee</h4>
        
            <div id="about-card-bio"><p>Once work as assistant teacher, and now in LN bld Technology Co. Ltd</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Developer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                LN
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-vufjrm3fmbuttogo1hxuu0w9w0sesk5iyysjuguc2hdhufot9szxg8twijry.min.js"></script>
<!--SCRIPTS END-->

    



    </body>
</html>
